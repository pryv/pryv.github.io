<!DOCTYPE html><html lang="en" class="no-js"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" property="og:description" content="Pryv API reference and resources for developers"><meta name="author" content="Pryv SA"><meta property="og:type" content="website"><meta name="image" property="og:image" content="/assets/images/logo-256.png"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Custom Authentication | Pryv API</title><link rel="icon" href="/assets/images/favicon-black.ico" type="image/x-icon"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/apple-touch-icon-120x120-black.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/apple-touch-icon-152x152-black.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon-180x180-black.png"><!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,300,500,700,400italic|Roboto+Condensed:400,300,700"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/docco.min.css"><link rel="stylesheet" type="text/css" href="/assets/fonts/ss-gizmo.min.css"><link rel="stylesheet" type="text/css" href="/assets/style.css"></head><body class="custom-auth with-toc"><header id="page-header"><nav role="navigation" class="navbar navbar-default navbar-fixed-top"><div class="container-fluid"><div class="navbar-header"><a href="https://pryv.com" title="Pryv home" class="navbar-brand logo pryv-home"><img src="/assets/images/icon-home.svg" alt="Pryv home" height="50"></a><a href="/" title="Developers home" class="navbar-brand logo"><img src="/assets/images/logo-256-black.png" alt="Developers home"></a><button type="button" data-toggle="collapse" data-target="#main-nav" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div id="main-nav" class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Guides <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="/getting-started/">Getting started</a></li><li><a href="/concepts/">API concepts</a></li><li><a href="/guides/data-modelling/">Data modelling</a></li><li><a href="/guides/webhooks/">Webhooks</a></li><li><a href="/guides/custom-auth/">Custom auth</a></li><li><a href="/guides/app-guidelines/">App guidelines</a></li><li><a href="/external-resources/">External resources</a></li></ul></li><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Reference <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="/reference/">API reference</a></li><li><a href="/reference-system/">API System reference</a></li><li><a href="/event-types/">Event types</a></li><li><a href="/open-api/">Open API (Postman)</a></li><li><a href="/change-log/">API change log</a></li><!--+menuItem('standardStructure')--></ul></li><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">FAQ <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="/faq-api/">API</a></li><li><a href="/faq-infra/">Infrastructure</a></li></ul></li><li><a href="https://support.pryv.com/hc/en-us/community/topics">Community</a></li><li><a href="https://github.com/pryv/open-pryv.io">Open Pryv.io</a></li><li><a href="/roadmap">Roadmap</a></li></ul><div class="navbar-right"><p class="navbar-text version"><a href="/change-log/" title="View change log">API version: <strong>1.5.22</strong></a></p></div></div></div></nav></header><div id="main-wrapper" class="container container-narrow"><div id="main"><h1 class="page-title">Custom Authentication</h1><h1 id="introduction">Introduction</h1>
<p>bla bla</p>
<h1 id="how-to-use-it">How to use it</h1>
<h2 id="function-to-implement">function to implement</h2>
<p>It is possible to extend the API and previews servers with your own code, via the configuration keys defined under <code>customExtensions</code>:</p>
<ul>
<li><code>defaultFolder</code>: The folder in which custom extension modules are searched for by default. Unless defined by its specific setting (see other settings in <code>customExtensions</code>), each module is loaded from there by its default name (e.g. <code>customAuthStepFn.js</code>), or ignored if missing. Defaults to <code>{app root}/custom-extensions</code>.</li>
<li><p><code>customAuthStepFn</code>: A Node module identifier (e.g. <code>/custom/auth/function.js</code>) implementing a custom auth step (such as authenticating the caller id against an external service). The function is passed the method context, which it can alter, and a callback to be called with either no argument (success) or an error (failure). If this setting is not empty and the specified module cannot be loaded as a function, server startup will fail. Undefined by default.</p>
<pre><code class="lang-javascript">  // Example of customAuthStepFn.js
  module.exports = function (context, callback) {
    // do whatever is needed here (check LDAP, custom DB, etc.)
    doCustomParsingAndValidating(context, function (err, parsedCallerId) {
      if (err) { return callback(err); }
      context.originalCallerId = context.callerId;
      context.callerId = parsedCallerId;
      callback();
    });
  };
</code></pre>
<p>  Available context properties (as of now):</p>
<ul>
<li><code>username</code> (string)</li>
<li><code>user</code> (object): the user object (properties include <code>id</code>)</li>
<li><code>accessToken</code> (string): as read in the <code>Authorization</code> header or <code>auth</code> parameter</li>
<li><code>callerId</code> (string): optional additional id passed after <code>accessToken</code> in auth after a separating space (auth format is thus <code>&lt;access-token&gt;[ &lt;caller-id&gt;]</code>)</li>
<li><code>access</code> (object): the access object (see <a href="https://api.pryv.com/reference/#access">API doc</a> for structure) </li>
</ul>
</li>
</ul>
<h2 id="how-to-turn-it-on">how to turn it on</h2>
<ul>
<li>what folder</li>
<li>reboot services</li>
</ul>
<p>probably not going into details as such might change and depend on the: setup, version</p>
<h1 id="examples">Examples</h1>
<h2 id="authenticate-authorization-token-with-pryv-io">Authenticate authorization token with Pryv.io</h2>
<p>INSERT SCHEMA HERE</p>
<p>Bob wants to create an Access exclusive to Alice.</p>
<ul>
<li>1 Alice creates an Access for verification:</li>
</ul>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;alices-verification-abc&quot;,
  &quot;token&quot;: &quot;alices-token&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;alices-access&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;verify&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
  // ...
}
</code></pre>
<ul>
<li><p>2 Alice provides Bob with:</p>
<ul>
<li>her apiEndpoint: <code>https://alice.pryv.me/</code></li>
<li>the <code>id</code> of her access: <code>alices-verification-abc</code></li>
</ul>
</li>
<li><p>3 Bob creates an Access for Alice that will be verified by the custom auth step:</p>
</li>
</ul>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;ckdoc7cca0001m1pv5ju4msy5&quot;,
  &quot;token&quot;: &quot;bobs-token-for-alice&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;bobs-access-for-alice&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;health&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
  &quot;clientData&quot;: {
    &quot;customAuth&quot;: {
      &quot;PryvAuthentication&quot;: {
        &quot;apiEndpoint&quot;: &quot;https://alice.pryv.me/&quot;,
        &quot;id&quot;: &quot;alices-verification-abc&quot;
      }
    }
  }
  // ...
}
</code></pre>
<ul>
<li>4 Alice queries Bob&#39;s data with the following headers:</li>
</ul>
<pre><code>Authorization: bobs-token-for-alice
PryvAuthentication: alices-token
</code></pre><ul>
<li>5</li>
<li>5.1 The Pryv.io API validates <code>bobs-token-for-alice</code></li>
<li>5.2 The custom auth function looks for a field <code>customAuth:PryvAuthentication</code> in the retrieved Access&#39; <code>clientData</code></li>
<li><p>5.3 Upon finding it, it fetches Alice&#39;s token&#39;s information</p>
<pre><code>GET {API_ENDPOINT}/access-info

Authorization: alices-token
</code></pre></li>
<li><p>5.4 It receives the access information:</p>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;alices-verification-abc&quot;,
  &quot;token&quot;: &quot;alices-token&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;alices-access&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;verify&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
  // ...
}
</code></pre>
</li>
<li><p>5.5 It compares the Access <code>id</code> with the one that was saved in the clientData. If it matches, it allows permission to the data, otherwise refuses it.</p>
</li>
</ul>
<h3 id="accesses">Accesses</h3>
<h3 id="custom-auth-function">Custom auth function</h3>
<pre><code class="lang-javascript">module.exports = function(context, callback) {
  const http = require(&#39;http&#39;);
  if (context.access.clientData) {
    // aliceApiEndpoint/access-info?auth=alice_token
    http.get(context.access.clientData[&quot;customAuthStep/PryvToken&quot;].apiEndPoint + &#39;/access-info?auth=&#39; + context.callerId, (resp) =&gt; {
      //alice accessId == clientData.customAuthStep/PryvToken accessId
      if (resp.headers[&#39;pryv-access-id&#39;] == context.access.clientData[&quot;customAuthStep/PryvToken&quot;].accessId) {
        return callback()
      }
      callback(new Error(&#39;AccessIds do not correpond&#39;))
    }).end();
  } else {
    callback(new Error(&#39;no clientData in access&#39;));
  }
};
</code></pre>
<h2 id="authenticate-authorization-token-with-external-service">Authenticate authorization token with external service</h2>
<p>TBD or not</p>
</div><nav id="toc"></nav></div><footer id="page-footer"><nav class="navbar navbar-default"><div class="container-fluid"><div id="footer-nav"><ul class="nav navbar-nav"><li><a href="mailto:developers@pryv.com">Send a message</a></li><li><a href="https://github.com/pryv">GitHub</a></li><li><a href="https://pryv.com">pryv.com</a></li></ul></div></div></nav></footer><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script src="/assets/bootstrap.min.js"></script><script src="/assets/js/toc.min.js"></script><!-- TOC generation--><script>jQuery(document).ready(function($) {
  // Header is about 51 pixels. This equals to 'header + fuzz', fuzz was
  // determined experimentally.
  var offset = 90;

  // Display TOC on the left side of the page.
  $('#toc').toc({
    selector: '#main h1:not(.page-title),#main h2,#main h3',
    ulClass: 'nav'
  });

  // Synchronise scroll/click motion with TOC display.
  $(document).ready(function() {
    // NOTE This is done at onLoad since we need to wait for all CSS
    // to appear.
    $('body').scrollspy({
      target: '#toc',
      offset: offset
    });
    scrollBy(0, 1); // make it scroll to be sure scrollspy gets it
    
    // fix offset when navigating
    $('#toc li a, a.toc-anchor').click(function (e) {
      e.preventDefault();
      var target = $(this).attr('href');
      window.location.hash = target;
      
      $(target)[0].scrollIntoView();
      if ($(window).scrollTop() + $(window).height() !== $(document).height()) {
        //only adjust when not at bottom
        scrollBy(0, -offset + 40);
      }
      return true;
    });
  
  });
});
</script><!-- Code blocks highlighting--><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><!-- Google Analytics--><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36589447-2']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>