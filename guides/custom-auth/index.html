<!DOCTYPE html><html lang="en" class="no-js"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="description" property="og:description" content="Pryv API reference and resources for developers"><meta name="author" content="Pryv SA"><meta property="og:type" content="website"><meta name="image" property="og:image" content="/assets/images/logo-256.png"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Custom Authentication | Pryv API</title><link rel="icon" href="/assets/images/favicon-black.ico" type="image/x-icon"><link rel="apple-touch-icon" sizes="120x120" href="/assets/images/apple-touch-icon-120x120-black.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/images/apple-touch-icon-152x152-black.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon-180x180-black.png"><!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:400,300,500,700,400italic|Roboto+Condensed:400,300,700"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/docco.min.css"><link rel="stylesheet" type="text/css" href="/assets/fonts/ss-gizmo.min.css"><link rel="stylesheet" type="text/css" href="/assets/style.css"></head><body class="custom-auth with-toc"><header id="page-header"><nav role="navigation" class="navbar navbar-default navbar-fixed-top"><div class="container-fluid"><div class="navbar-header"><a href="https://pryv.com" title="Pryv home" class="navbar-brand logo pryv-home"><img src="/assets/images/icon-home.svg" alt="Pryv home" height="50"></a><a href="/" title="Developers home" class="navbar-brand logo"><img src="/assets/images/logo-256-black.png" alt="Developers home"></a><button type="button" data-toggle="collapse" data-target="#main-nav" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div id="main-nav" class="collapse navbar-collapse"><ul class="nav navbar-nav"><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Guides <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="/getting-started/">Getting started</a></li><li><a href="/concepts/">API concepts</a></li><li><a href="/guides/data-modelling/">Data modelling</a></li><li><a href="/guides/webhooks/">Webhooks</a></li><li><a href="/guides/custom-auth/">Custom auth</a></li><li><a href="/guides/app-guidelines/">App guidelines</a></li><li><a href="/external-resources/">External resources</a></li></ul></li><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">Reference <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="/reference/">API reference</a></li><li><a href="/reference-system/">API System reference</a></li><li><a href="/event-types/">Event types</a></li><li><a href="/open-api/">Open API (Postman)</a></li><li><a href="/change-log/">API change log</a></li><!--+menuItem('standardStructure')--></ul></li><li class="dropdown"><a href="#" data-toggle="dropdown" class="dropdown-toggle">FAQ <b class="caret"></b></a><ul class="dropdown-menu"><li><a href="/faq-api/">API</a></li><li><a href="/faq-infra/">Infrastructure</a></li></ul></li><li><a href="https://support.pryv.com/hc/en-us/community/topics">Community</a></li><li><a href="https://github.com/pryv/open-pryv.io">Open Pryv.io</a></li><li><a href="/roadmap">Roadmap</a></li></ul><div class="navbar-right"><p class="navbar-text version"><a href="/change-log/" title="View change log">API version: <strong>1.5.22</strong></a></p></div></div></div></nav></header><div id="main-wrapper" class="container container-narrow"><div id="main"><h1 class="page-title">Custom Authentication</h1><h2 id="table-of-contents">Table of contents</h2>
<ol>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#pryv-io-custom-auth-step">Pryv.io Custom Auth Step</a><ol>
<li><a href="#why-using-a-custom-auth-step">Why using a custom auth step</a></li>
<li><a href="#what-is-a-custom-auth-step">What is the custom auth step</a></li>
<li><a href="#how-to-set-up-the-custom-auth-step">How to set up the custom auth step</a></li>
</ol>
</li>
<li><a href="authenticate-authorization-token-with-pryv-io">Authenticate authorization token with Pryv.io</a><ol>
<li><a href="#hands-on-example">Hands-on example</a></li>
</ol>
</li>
<li><a href="#custom-auth-step-features">Custom Auth Step features</a><ol>
<li><a href="#accesses">Accesses</a></li>
<li><a href="#custom-authentication-function">Custom Authentication function</a></li>
</ol>
</li>
<li><a href="authenticate-authorization-token-with-an-external-service">Authenticate authorization token with an external service</a></li>
</ol>
<h2 id="introduction">Introduction</h2>
<p>Authentication allows you to validate the identity of a registered user attempting to access resources. You can add a custom authentication step to your Pryv.io platform to verify more information than the authorization token when performing a request to access data.  </p>
<p>In this guide, we explain how to provide your Pryv.io instance with this feature and illustrate it with a concrete use case. </p>
<h2 id="pryv-io-custom-auth-step">Pryv.io Custom Auth Step</h2>
<h3 id="why-using-a-custom-auth-step">Why using a custom auth step</h3>
<p>You can already keep track of actions performed by clients against the Pryv.io API using the <a href="/reference/#audit-log">Pryv.io Audit Capabilities</a> that enable you to track when an access token was used for example. The Custom Auth step allows the Pryv.io platform to authenticate a user with more information than the access token.</p>
<p>For example, if a Alice needs to access data from Bob in your Pryv.io platform, you can implement an authentication step that will allow you to verify the identity of user Alice when she tries to access data from Bob, and keep the identity of user Alice in the audit logs. The identity of the requester (Alice) can be verified through a custom auth step that you can add to your Pryv.io platform implementation as explained below.</p>
<h3 id="what-is-the-custom-auth-step">What is the custom auth step</h3>
<p>You can define a function that has access
The function you will implement to augment your Pryv.io platform with authentication capabilities will be part of the custom extension modules that need to be added in your platform configuration.<br>It is possible to extend the API and servers with your own code. Your custom auth step will allow you to use the information stored in the context to authenticate a user.  </p>
<p>The available properties of the context are (as of now):</p>
<ul>
<li><code>username</code> (string)</li>
<li><code>user</code> (object): the user object (properties include <code>id</code>)</li>
<li><code>accessToken</code> (string): as read in the <code>Authorization</code> header or <code>auth</code> parameter</li>
<li><code>callerId</code> (string): optional additional id passed after <code>accessToken</code> in auth after a separating space (auth format is thus <code>[&lt;access-token&gt; &lt;caller-id&gt;]</code>)</li>
<li><code>access</code> (object): the access object (see <a href="https://api.pryv.com/reference/#access">API doc</a> for structure) </li>
</ul>
<h3 id="how-to-set-up-the-custom-auth-step">How to set up the custom auth step</h3>
<p>You can add your custom code in the configuration file of your Pryv.io platform under the <code>customExtensions</code> field. By default, the API server checks <code>{app root}/custom-extensions/customAuthStepFn.js</code> to find a custom auth step. You can modify the default name in <code>{app root}/components/api-server/src/settings.js</code>.</p>
<p>Once your server is up and running:</p>
<ul>
<li>run <code>yarn release</code> to create distribution for the release</li>
<li>run <code>yarn api</code>  in core-services to restart the API server</li>
</ul>
<h2 id="authenticate-authorization-token-with-pryv-io">Authenticate authorization token with Pryv.io</h2>
<p>In this section, we illustrate the usage of a custom auth step through a basic use case. Bob wants to share his data with Alice, and creates an access for her on the stream &quot;Health&quot; with a &quot;read&quot; permission (more information on the <strong>Access structure</strong> <a href="/reference/#data-structure-access">here</a>). </p>
<p>When Alice is requesting access to this stream, the custom auth step will allow to verify Alice&#39;s identity using an access for verification and validate her request. This implies the creation of a &quot;verification&quot; access for Alice that will only be used to validate her identity.</p>
<h3 id="hands-on-example">Hands-on example</h3>
<p>The following scheme explains the different steps of the process using Pryv.io custom auth step.  </p>
<p> </p>
 <p align="center">
<img src="/assets/gifs/alice-bob.gif" />
</p></p>
<p>Bob wants to create an <a href="/reference/#data-structure-access">Access</a> exclusive to Alice on his stream &quot;Health&quot; with a &quot;read&quot; permission.</p>
<ul>
<li>1 Alice creates an <strong>Access for verification</strong>, that will only be used by the custom auth step to validate her identity. The custom auth step will check that the access id of this <strong>Access</strong> and the access id stored in Bob&#39;s access for Alice match (see step nÂ°6). This implies the creation of a stream &quot;Verify&quot; dedicated to this process.</li>
</ul>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;alices-verification-abc&quot;,
  &quot;token&quot;: &quot;alices-token-for-bob&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;alices-access&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;verify&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
}
</code></pre>
<ul>
<li><p>2 Alice provides Bob with:</p>
<ul>
<li>her apiEndpoint: <code>https://alice.pryv.me/</code></li>
<li>the <code>id</code> of her access previously created (see above): <code>alices-verification-abc</code></li>
</ul>
</li>
<li><p>3</p>
<ul>
<li>3.1 Bob creates an Access for Alice on the stream &quot;Health&quot; that will be verified by the custom auth step. </li>
<li>3.2 In the <code>clientData</code> field, he adds her apiEndpoint and the <code>id</code> of her access that she provided him with in the previous step.</li>
</ul>
</li>
</ul>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;ckdoc7cca0001m1pv5ju4msy5&quot;,
  &quot;token&quot;: &quot;bobs-token-for-alice&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;bobs-access-for-alice&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;health&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
  &quot;clientData&quot;: {
    &quot;customAuth&quot;: {
      &quot;PryvAuthentication&quot;: {
        &quot;apiEndpoint&quot;: &quot;https://alice.pryv.me/&quot;,
        &quot;accessId&quot;: &quot;alices-verification-abc&quot;
      }
    }
  }
}
</code></pre>
<ul>
<li>4 Alice queries Bob&#39;s data with the following header:</li>
</ul>
<pre><code>[&lt;access-token&gt;: bobs-token-for-alice &lt;caller-id&gt;: alices-token-for-bob]
</code></pre><p>It should follow the auth format as specified in the <code>context</code> properties of the function <code>customAuthStepFn</code> (see <a href="#function-to-implement">previous section</a>): <code>[&lt;access-token&gt; &lt;caller-id&gt;]</code> .</p>
<ul>
<li><p>5 </p>
<ul>
<li>5.1 The Pryv.io API validates <code>bobs-token-for-alice</code>.</li>
<li>5.2 The Custom Authentication function looks for a field <code>customAuth.PryvAuthentication</code> in the retrieved Access&#39; <code>clientData</code>.</li>
<li>5.3 Upon finding it, it fetches Alice&#39;s token&#39;s information, using Alice&#39;s <code>apiEndpoint</code> that is provided in the <code>clientData</code> field of Bob&#39;s access:</li>
</ul>
<pre><code>GET {apiEndpoint}/access-info

Authorization: alices-token-for-bob
</code></pre><ul>
<li>5.4 It receives the access information of Alice&#39;s verification token:</li>
</ul>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;alices-verification-abc&quot;,
  &quot;token&quot;: &quot;alices-token-for-bob&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;alices-access&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;verify&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
}
</code></pre>
</li>
<li><p>6 It compares the retrieved Access <code>id</code> (<code>&quot;id&quot;: &quot;alices-verification-abc&quot;</code>) with the one from Bob access&#39; clientData: <code>clientData.customAuth.PryvAuthentication.id</code>. If it matches, it allows permission to the data, otherwise it refuses it.</p>
</li>
</ul>
<h2 id="custom-auth-step-features">Custom Auth Step features</h2>
<p>The implementation of the custom auth step requires the creation of different accesses and the function of authentication itself, that you can customize according to your needs using its <code>context</code> argument.</p>
<h3 id="accesses">Accesses</h3>
<p>As explained in the example below, granting access to a third party and verifying the accessor&#39;s identity implies the creation of two distinct accesses:</p>
<ul>
<li>the access to Bob&#39;s data, defined by Bob</li>
<li>the &quot;verification&quot; access, used only to validate Alice&#39;s identity, created by Alice</li>
</ul>
<p>These accesses serve different purposes and should be defined similarly as below:</p>
<ul>
<li>1 Alice&#39;s &quot;verification&quot; access that enables Pryv.io custom auth step to validate her identity. A &quot;mock&quot; stream (here the stream &quot;Verify&quot;) needs to be created to be able to generate an access on it. The id of this access needs to be communicated to Bob so that he integrates it in the <code>clientData</code> field of the access he creates for Alice.</li>
</ul>
<p><strong>POST /accesses</strong> for Alice&#39;s verification access: </p>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;alices-verification-abc&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;alices-access&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;verify&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
}
</code></pre>
<ul>
<li>2 Bob&#39;s access for Alice enables Alice to access one or multiple streams of his Pryv.io data, with different permissions. It has the particularity of having a <code>clientData</code> field that contains information to verify Alice&#39;s identity: her <strong>apiEndpoint</strong> and the <strong>id</strong> of her &quot;verification&quot; access.<br>In our example, Bob&#39;s defines an access on his stream &quot;Health&quot; with a &quot;read&quot; permission.</li>
</ul>
<p><strong>POST /accesses</strong> for Bob&#39;s access: </p>
<pre><code class="lang-json">{
  &quot;id&quot;: &quot;ckdoc7cca0001m1pv5ju4msy5&quot;,
  &quot;type&quot;: &quot;shared&quot;,
  &quot;name&quot;: &quot;bobs-access-for-alice&quot;,
  &quot;permissions&quot;: [
    {
      &quot;streamId&quot;: &quot;health&quot;,
      &quot;level&quot;: &quot;read&quot;
    }
  ],
  &quot;clientData&quot;: {
    &quot;customAuth&quot;: {
      &quot;PryvAuthentication&quot;: {
        &quot;apiEndpoint&quot;: &quot;https://alice.pryv.me/&quot;,
        &quot;accessId&quot;: &quot;alices-verification-abc&quot;
      }
    }
  }
}
</code></pre>
<p>The custom auth step will compare the access id for Alice&#39;s verification token contained in the <code>clientData</code> field and the id contained in the response of the call to access-info. If it matches, Alice&#39;s identity is verified and the authentication is successful. </p>
<h3 id="custom-authentication-function">Custom Authentication function</h3>
<p>The Custom Authentication function used by the custom auth step to validate Alice&#39;s identity is described below.</p>
<pre><code class="lang-javascript">const http = require(&#39;http&#39;);
module.exports = function (context, callback) {
    const access = context.access;
    if (access.clientData &amp;&amp; access.clientData.customAuth &amp;&amp; access.clientData.customAuth.PryvAuthentication) {
        // aliceApiEndpoint/access-info?auth=alice_token
        http.get(access.clientData.customAuth.PryvAuthentication.apiEndpoint + &#39;/access-info?auth=&#39; + context.callerId, (resp) =&gt; {
            //alice accessId == clientData.customAuth.PryvAuthentication.accessId
            if (resp.headers[&#39;pryv-access-id&#39;] == access.clientData.customAuth.PryvAuthentication.accessId) {
                return callback()
            }
            callback(new Error(&#39;accessIds do not correpond&#39;))
        }).end();
    } else {
        //access was created without clientData =&gt; no other verification
        callback();
    }
};
</code></pre>
<p>The arguments <code>context</code> and <code>callback</code> need to be passed as arguments to the method. Available properties of the context can be found in the section <a href="#what-is-a-custom-auth-step">above</a>.</p>
<pre><code class="lang-javascript">module.exports = function(context, callback) {
  const http = require(&#39;http&#39;);
</code></pre>
<p>The method first verifies that the access (<code>context</code> property) has a non empty <code>clientData</code> field. If it is the case, an error is thrown:</p>
<pre><code class="lang-javascript">if (context.access.clientData){ 
  //...
}
else {
    callback(new Error(&#39;no clientData in access&#39;));
}
</code></pre>
<p>If it is not the case, it fetches the <strong>apiEndpoint</strong> from <code>clientData</code> and performs a <a href="/reference/#access-info"><strong>getAccessInfo call</strong></a> with the apiEndpoint and the callerId (<code>context</code> property), that corresponds to Alice&#39;s token.</p>
<pre><code class="lang-javascript">if (context.access.clientData) {
    // aliceApiEndpoint/access-info?auth=alice_token
    http.get(context.access.clientData.customAuth.PryvAuthentication.apiEndPoint + &#39;/access-info?auth=&#39; + context.callerId, (resp) =&gt; {
</code></pre>
<p>It then compares the access id for Alice&#39;s verification token contained in the <code>clientData</code> field and the id contained in the response of the call to access-info. If it matches, the authentication is successful:</p>
<pre><code class="lang-javascript">{
//alice accessId == clientData.customAuth.PryvAuthentication.accessId
if (resp.headers[&#39;pryv-access-id&#39;] == context.access.clientData.customAuth.PryvAuthentication.accessId) {
  return callback()

}
</code></pre>
<p>If it doesn&#39;t match, an error is thrown:</p>
<pre><code class="lang-javascript">callback(new Error(&#39;AccessIds do not correpond&#39;))
</code></pre>
<h2 id="authenticate-authorization-token-with-an-external-service">Authenticate authorization token with an external service</h2>
<p>In the previous section, we presented a way to perform the authentication step inside Pryv.io by calling a custom module that you can add to your platform.
In some cases, you might want to perform the validation step outside Pryv.io using a third party authentication. This will require the validation of an additional token from the chosen external service using its API.  </p>
<p>We invite you to contact us directly if you wish to implement such a verification with Pryv.io.</p>
</div><nav id="toc"></nav></div><footer id="page-footer"><nav class="navbar navbar-default"><div class="container-fluid"><div id="footer-nav"><ul class="nav navbar-nav"><li><a href="mailto:developers@pryv.com">Send a message</a></li><li><a href="https://github.com/pryv">GitHub</a></li><li><a href="https://pryv.com">pryv.com</a></li></ul></div></div></nav></footer><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script><script src="/assets/bootstrap.min.js"></script><script src="/assets/js/toc.min.js"></script><!-- TOC generation--><script>jQuery(document).ready(function($) {
  // Header is about 51 pixels. This equals to 'header + fuzz', fuzz was
  // determined experimentally.
  var offset = 90;

  // Display TOC on the left side of the page.
  $('#toc').toc({
    selector: '#main h1:not(.page-title),#main h2,#main h3',
    ulClass: 'nav'
  });

  // Synchronise scroll/click motion with TOC display.
  $(document).ready(function() {
    // NOTE This is done at onLoad since we need to wait for all CSS
    // to appear.
    $('body').scrollspy({
      target: '#toc',
      offset: offset
    });
    scrollBy(0, 1); // make it scroll to be sure scrollspy gets it
    
    // fix offset when navigating
    $('#toc li a, a.toc-anchor').click(function (e) {
      e.preventDefault();
      var target = $(this).attr('href');
      window.location.hash = target;
      
      $(target)[0].scrollIntoView();
      if ($(window).scrollTop() + $(window).height() !== $(document).height()) {
        //only adjust when not at bottom
        scrollBy(0, -offset + 40);
      }
      return true;
    });
  
  });
});
</script><!-- Code blocks highlighting--><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();
</script><!-- Google Analytics--><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-36589447-2']);
_gaq.push(['_trackPageview']);
(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></body></html>